name: Custom Auto Versioning

permissions:
  contents: write # Required to push the new version file back to the repo

on:
  push:
    branches:
      - main # Trigger only when code hits the main branch

jobs:
  update-version:
    runs-on: ubuntu-latest
    # This 'if' line prevents an infinite loop where the bot triggers itself
    if: "!contains(github.event.head_commit.message, '[skip ci]')"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Calculate Version & Update Files
        id: version_calc
        run: |
          # 1. We use a small Node script inline to handle the logic cleanly
          node -e '
            const fs = require("fs");
            
            // Read the current configuration
            const meta = require("./meta-data.json");
            
            // Get current date components
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, "0");
            const day = String(now.getDate()).padStart(2, "0");
            const hours = String(now.getHours()).padStart(2, "0");
            const minutes = String(now.getMinutes()).padStart(2, "0");
            
            // Construct the version: Major.Year.Month.Day.Time
            // Example: 1.2025.11.28.1045
            const newVersion = `${meta.major}.${year}.${month}.${day}.${hours}${minutes}`;
            
            // Update the object
            meta.version = newVersion;
            meta.message = process.env.COMMIT_MSG; 
            
            // Write back to Root (for storage)
            fs.writeFileSync("./meta-data.json", JSON.stringify(meta, null, 2));
            
            // Write to SRC (so React can import it easily)
            fs.writeFileSync("./src/meta-data.json", JSON.stringify(meta, null, 2));
            
            console.log(`Updated version to: ${newVersion}`);
          '
        env:
          COMMIT_MSG: ${{ github.event.head_commit.message }}

      - name: Commit and Push Changes
        run: |
          git config --global user.name 'GitHub Action Bot'
          git config --global user.email 'actions@github.com'
          
          # We add both the root file (storage) and the src file (display)
          git add meta-data.json src/meta-data.json
          
          # [skip ci] is CRITICAL. It tells GitHub "Don not run this Action again" for this commit.
          git commit -m "Auto-update version [skip ci]"
          git push
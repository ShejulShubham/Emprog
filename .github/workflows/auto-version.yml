name: Custom Auto Versioning

permissions:
  contents: write # Required to push the new version file back to the repo

on:
  push:
    branches:
      - main # Trigger only when code hits the main branch

jobs:
  update-version:
    runs-on: ubuntu-latest
    # This 'if' line prevents an infinite loop where the bot triggers itself
    if: "!contains(github.event.head_commit.message, '[skip ci]')"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Calculate Version & Update Files
        id: version_calc
        run: |
          node <<'EOF'
            const fs = require("fs");
            
            // 1. Load the data
            const meta = JSON.parse(fs.readFileSync("./meta-data.json", "utf8"));
            
            // 2. Generate version strings
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, "0");
            const day = String(now.getDate()).padStart(2, "0");
            const hours = String(now.getHours()).padStart(2, "0");
            const minutes = String(now.getMinutes()).padStart(2, "0");
            const newVersion = `${meta.major}.${year}.${month}.${day}.${hours}${minutes}`;
            
            // 3. Create the new entry
            const newEntry = {
              version: newVersion,
              message: process.env.COMMIT_MSG || "Manual build",
              timestamp: now.toISOString()
            };

            // 4. Update History
            if (!meta.history) meta.history = [];
            meta.history.unshift(newEntry);
            if (meta.history.length > 50) meta.history = meta.history.slice(0, 50);
            meta.latest = newEntry;
            
            // 5. Write files
            const output = JSON.stringify(meta, null, 2);
            fs.writeFileSync("./meta-data.json", output);
            fs.writeFileSync("./src/meta-data.json", output);
            
            console.log("Successfully updated version to " + newVersion);
          EOF
        env:
          # This is critical: passing the message as an env var 
          # prevents shell injection/syntax errors from quotes in messages
          COMMIT_MSG: ${{ github.event.head_commit.message }}

      - name: Commit and Push Changes
        run: |
          git config --global user.name 'GitHub Action Bot'
          git config --global user.email 'actions@github.com'
          
          # We add both the root file (storage) and the src file (display)
          git add meta-data.json src/meta-data.json
          
          # [skip ci] is CRITICAL. It tells GitHub "Don not run this Action again" for this commit.
          git commit -m "Auto-update version [skip ci]"
          git push